# Проектирование высоконагруженных систем
## 1. Тема и целевая аудитория
### Тема: X

Информация о сервисе и нагрузке:
- DAU 217 миллионов пользователей. (в лекции было 436, взято из [2](https://www.meltwater.com/en/blog/twitter-stats-marketers-need-to-know))

| Гендер  | Процент (%) |
| --- | ------ |
| Мужчина | 56 |
| Женщина | 44 |



| Возраст (лет) | Процент пользователей (%) |
| --- | ------ |
| 13-17 |  6.6   |
| 18-24 |  17.1   |
| 25-34 |  38.5  |
| 35-49 |  20.7   |
| 50+  | 17.1   |

MVP функционал:
- Регистрация   
- Аккаунт: профиль, информация о профиле
- Фото и видео для профиля
- твиты, фото и видео в твитах, репосты твитов
- комментарии к твитам и комментарии к комментариям(в виде дерева)
- рекомендательная система твитов
- Настройки профиля
- Поиск: поиск по хэштегам
- Уведомления

Ключевой функционал - посты и поиск по ним.
Ключевые продуктовые решения:
- хэштеги: для поиска и группировки твитов по темам
- ретвиты

## 2. Расчет нагрузки

### Продуктовые метрики

| метрика | значение |
| --- | ------ |
| MAU |  550MM |
| DAU |  217MM |

| память на 1 | значение |
| --- | ------ |
| твит |  300 байт |
| фото | 16 кбайт |
| видео | 600 кБайт |


| действия пользователя (среднее) | значение | память |
| ---  | ---- |  --- |
| чтение твитов | 50 | - |
| лайк (твита и комментария) | 10 | 8 байт |
| поиск твита | 20 | - |
| написание комментария | 4 | 100 байт |
| написания твита | 2.4 | (расчитано ниже) |
| репост твита | 1.7 | - |

возьмём, что каждый 3 твит с видео, и в каждом твите в среднем есть 2 фотографии.

32 КБ + 200 Байт = 32.2 КБ (твит с 2 фото)
200 байт + 600 КБайт = 0.6002 МБ(твит с видео)
100 байт * 10 = 1000 байт ~ 1КБ (комментарии)

Средний размер хранилища пользователя - 532.176 КБ - пользователь/ сутки

### Технические метрики

хранения в разбивке по типам данных

| Данные | Кол-во в сутки | память в сутки (ГБ) |
| ---   |  -- |  ---              |
| твиты | 518.4 M |     145       |
| фото | 1 B |          15820     |
| видео | 172 M |       98420     |
| комментарии | 1.3 B | 81 |

| Сетевой трафик | среднее потребление | пиковое потребление |
| --- | ---- | --- |
| твиты | 0.001678  ГБ/c |  0.004195 ГБ/c  | 
| фото |  0.1831018 ГБ/c   |  0.4577545 ГБ/c  |
| видео | 1.13912037 ГБ/c   | 2.847800925  ГБ/c |

Суммарный суточный  трафик - 114466 ГБ/cутки

| RPS | средний | пик |
| ---  | ---- | --- |
| получение твита | 125787  | 314467 |
| лайк твита | 25157  | 62892 |
| поиск твита | 25574  | 62835 |
| написание комментария | 15000  | 37500 |
| написания твита | 6000 | 15000  | 
| репост твита | 4276  | 10691  |
| проверка авторизации + авторизация | 200000 | 250000 |
| изменение настроек профиля | 200 | 450 |
| подписка на / отписка от пользователя | 600 | 1500 |

## Глобальная балансировка нагрузки.

Разбиение по доменам.

x.com.static - домен для статического контента 
x.com.auth - домен для проверки регистрации/ авторизации
x.com.tweet - домен для получения твита
x.com.user - домен для получения странички пользователя - настроек



| Регион | % пользователей |
| --- | -- |
| Северная Америка | 35.62% |
| Азия | 46.20% |
| Европа | 11.90% |
| Южная Америка | 6.28% |


| Расположение ДЦ | назначение |
| --- | -- |
| Атланта (Джорджия) | основной (США) |
| Портленде (Орегон) | основной (США) |
| Даллас (Техас) |  основной (США) |
| Мумбаи (Индия) | основной (Азия) |
| Сингнапур | основной (Азия) |
| Дублин (Ирландия) | основной (Европа) |
| Нью-Йорк | CDN (США) |
| Сеул (Южная Корея) | CDN (Азия) |
| Токио (Япония) | CDN (Азия) |
| Франкфурт (Германия) | CDN (Европа) |
| Сан-Паулу (Бразилия) | CDN (Южная америка) |
| Сидней (Австралия) | CDN (Океания) | 


Такое расположение основных датацентров, потому что наибольшая часть аудитории "X" находится в США и Азии, после идёт Европа и Южная Америка. Такое расположениец ДЦ позволит ускорить доступ к сервису для большей части аудитории, а CDN ускорит отдачу статического контента в удаленных регионах и уменьшит нагрузку на основные ДЦ.

| Датацентр                              | % нагрузки    | 
| ---                                    | ----          |
| Атланта(Джорджия)                      | 14            | 
| Портленд (Орегон)                      | 14	         |
| Даллас(Техас)                          | 14	         |
| Сингнапур                              | 23.1          |
| Мумбаи (Индия)                         | 23.1          |
| Дублин (Ирландия)                      | 11.8          |


DNS балансировка - Latency-based DNS.

Latency-based DNS направляет запросы на сервер с наименьшей задержкой, постоянно измеряя время отклика.
Хорошо подходит, так как сеть глобально распределённая и сконцентрирована в некоторых странах особенно.
DNS сервера переодически проходятся по списку доступных серверов и определяют сервер с наименьшей задержкой и направляют запросы на него.

Anycast балансировка - BGP Anycast.
Отдельные IP для: США, Японии, Сингапура, Индии, Европы.
Будем использовать для устойчивости к сбоям, чтобы в случае если сервер выходит из строя запросы перенаправлялись на ближайший работающий. 

### Локальная балансировка нагрузки

Для входящего трафика будем использовать L4 балансировку - Virtual Server via Direct Routing. Есть ограничение, что сервера должны быть в одной физической сети, т.е. в рамках одного ДЦ. В каждом основном ДЦ
будет стоять балансировщик который будет распределять запросы в рамках датацентра. Балансировщики будут настроены с резервированием по протоколу CARP (Common Address Redundancy Protocol), что обеспечит отказоустойчивость и автоматическое переключение на резервный балансировщик в случае отказа основного.


С L4 балансировщика трафик будет попадать на L7 балансировщик. 


Будем использовать в качестве L7 балансировщика Nginx, чтобы предотвратить блокировку серверных ресурсов от "медленных пользователей", также на уровне Nginx добавим проверку авторизации, что позволит отсеивать неавторизованные запросы ещё до их попадания в бекенд.
В случае если бекенд упадет во время запроса, который не меняет БД, Nginx это поймет и перенаправит запрос на другой сервер, пользователь ничего не заметит, ещё уменьшаем нагрузку на бекенд, так как держим постоянные  соединения(upstreams) с бекендом.

Межсервисные запросы: используем Envoy, Least Connections для L7 балансировки межсервисных запросов в рамках ДЦ.

Отказоустойчивость: Будем использовать 2 кластера в Kubernetes с Autoscaling, что позволит в случае сбоя одного из кластеров обеспечить доступность к сервису, а autoscaling позволит увеличивать/уменьшать количество реплик в зависимости от нагрузки.

### Логическая схема БД и Физическая схема БД

![Схема бд](/Highload_Maxorella.png)

User.status(ENUM)
```
ACTIVE - обычное состояние
INACTIVE - пользователь "давно" не заходил
SHADOWBAN - пользователь находится в теневом бане(его твиты мало показываются в поиске)
BLOCKED - пользователь заблокирован, за спам и тп
DELETED - пользователь навсегда заблокирован
``` 

Tweet.status(ENUM)
```
PUBLISHED - обычное состояние
SHADOWBAN - твит в теневом бане
DELETED - твит удален
``` 

Сomment.status(ENUM)
```
PUBLISHED - комментарий опубликован
DELETED - комментарий удален
```

Subscribe.status(ENUM)
```
SUBSCRIBED - пользователь подписан
UNSUBSCRIBED - пользователь отписался
BLOCKED - пользователь заблокировал другого пользователя
```
Notification.status(ENUM)
```
READ - уведомление прочитано
UNREAD- уведомление не прочитано
DELETED - уведомление удалено
```
HashtagEvent.event_type(ENUM)
```
HASHTAG_CREATED - создан новый хештег
HASHTAG_USED - хештег использован в твите
HASHTAG_VIEWED - хештег просмотрен пользователем
HASHTAG_LIKED - хештег лайкнулу
HASHTAG_RETWEETED - твит с хештегом ретвитнули
```

User.setting(JSON)
```

```

| Таблица    | СУБД               | Индексы | Денормализация |  Шардирование | Требование у согласованности |
| ---        | ----               | ----    | ----           | ----          | ----                         |
| User      | apache cassandra   | user_id  | -              | по user_id    |  при  status - deleted нельзя перейти на страницу пользователя(но она сохраняется в базе) |
| Tweet      | apache cassandra   | tweet_id, user_id, created_at  |  популярные твиты собираем в отдельную таблицу | по tweet_id, user_id    |  мягкое удаление |
| Comment     | apache cassandra   | comment_id, tweet_id, user_id  |  денормализован для быстрого построения дерева комментариев | по comment_id, tweet_id    | при удалении комментария меняется status и становится недоступен текст и вложения комментария, но дерево сохраняется |
| Subscribe     | apache cassandra   | user_id, subscriber_id  | - |  по user_id    | при удалении комментария меняется status и становится недоступен текст и вложения комментария, но дерево сохраняется |
| Notification  | apache cassandra   | user_id  | - |  по user_id  | уведомления сохраняются при удалении пользователя |
| TweetHashtag  | apache cassandra   | hashtag_id, tweet_id  | денормализован hashtag, чтобы не ходить ещё в одну таблицу |  по hashtag  | не удаляются при удалении твита |
| Session  | Redis   | session_id, user_id  | - |  по session_id, user_id  | cессии действительны до expire_time, при отзыве сессии удаляется запись |
| MediaContent  | S3   | id  | - | -  | контент не удаляется при удалении tweet, comment, avatar |
| TweetStat  | ClickHouse   | tweet_id  | дублирование данных для аналитики | - | - |
| CommentStat  | ClickHouse   | tweet_id  | дублирование данных для аналитики | - | - |
| SubscribeStat  | ClickHouse   | tweet_id  | дублирование данных для аналитики | - | - |
| HashtagStat  | ClickHouse   | tweet_id  | дублирование данных для аналитики | - | - |
| Event  | Kafka   | user_id, action_id  | события сохраняются для дальнейшей обработки(шина данных) | - | - |

### Алгоритмы

| Алгоритм | Область применения | Мотивационная часть |
| --- | --- | --- |
| Model-based Collaborative Filtering(Коллаборативная фильтрация) |  Рекомендательная система для твитов |  Используется, чтобы рекомендовать пользователю контент(в моем случае твиты), основываясь на предпочтениях других пользователей с похожими интересами.  Подход не требует явного анализа текста твитов, а фокусируется на поведении и взаимодействиях пользователей с сервисом.  1)Матричная факторизация - создается матрица взаимодействий пользователей с твитами. 2)Модель факторизует эту матрицу на две меньшие матрицы: одна для пользователей, другая — для твитов, появляется вектор "скрытых признаков". 3)Модель обучается на известных данных о предпочтениях пользователей. |
| Контекстуальные рекомендации (Context-Aware Recommendations) |  Рекомендательная система для твитов |  Учитывает не только исторические данные о предпочтениях пользователя, но и контекст, в котором осуществляется взаимодействие с сервисом. Например: данные о текущем месте пользователя, времени, его активности и тп также могут вноситься в матрицу Collaborative Filtering. |
| BM25 (Best Matching 25) + Обратный индекс |  Ранжирование и поиск твитов(по тексту) | Каждый документ анализируется, а затем значения применяются в специальной формуле, которая учитывает их отношение к другим документам в коллекции. На основании этого расчета выдается конечная оценка, которая влияет на позицию документа в поисковой выдаче. Реализован в Elasticsearch. Этапы 1) Анализаторы разбиватют текст на токены. 2) Обратный индекс - в соответствие словам ставятся твиты, в которых они встречаются 3) Поиск по обратному индексу 4) Оценка релевантности твитов - ранжирование результатов (BM25) 5) Отдача твитов |
| Префиксное дерево(trie) |  Автодополнение текста в поиске по хэштегам и поиска пользователей | Каждый узел дерева содержит один символ и указатели на дочерние узлы. Ключ узла вычисляется как путь от корня до узла. Поиск места для вставки элемента: мы начинаем с корневого узла и идем по дереву вниз, создавая узлы, если они отсутствуют. После создания необходимых узлов устанавливаем флаг действительного ключа для последнего из них. Автодополнение помогает пользователям быстрее находить нужные хэштеги, имена пользователей или ключевые слова. Например, когда пользователь начинает вводить хэштег #twit, система может предложить #twitter, #twitch и другие варианты. |

### Технологии

| Технология | Область применения | Мотивационная часть | 
|---|---|---|
| Terraform, Ansible. | Управление инфраструктурой | Инструмент с открытым исходным кодом для управления инфраструктурой как кодом (IaC). Позволяет описывать и управлять инфраструктурой с помощью декларативного языка конфигурации, подойдет для конфигурации CDN, серверов. |
| Go (Golang) | Backend | ЯП, подходит для создания высоконагруженных backend-приложений, микросервисов, API. |
| Python | Backend | ЯП для backend-разработки, машинного обучения, анализа данных и веб-разработки. | 
| gRPC | Протокол межсервисного взаимодействия | Протокол для создания высокопроизводительных и масштабируемых микросервисных архитектур. Обеспечивает высокую скорость обмена данными, удобен для разработки и поддержки распределенных систем. | 
| Redis | NoSQL база данных | СУБД класса NoSQL, работающая со структурами данных типа «ключ — значение». Обеспечивает быстрый доступ к данным, используется для увеличения скорости приложений и снижения нагрузки на базы данных. | 
| Memcached | Кэширование данных | Memcached обеспечивает высокую производительность и низкую задержку, что делает его подходящим для кэширования данных. Поддерживает распределенное кэширование, что позволяет масштабировать систему и обеспечивать высокую доступность | 
| Apache Cassandra | NoSQL база данных | Распределенная NoSQL база данных с открытым исходным кодом. Обеспечивает высокую доступность, масштабируемость и устойчивость данных. Подходит для хранения структурированных и полуструктурированных данных в реальном времени. | 
| S3 | Облачное хранилище | Облачная платформа хранилища данных от Amazon, предоставляющая масштабируемое и недорогое хранилище для всех типов данных. Используется для архивирования и хранения больших файлов. | 
| Kafka | Потоковая обработка данных | Распределённый программный брокер сообщений с открытым исходным кодом. Используется для сбора, обработки и передачи данных в реальном времени. |
| ElasticSearch | Поиск и анализ данных | Полнотекстовая поисковая система, open source, позволяющая быстро и эффективно анализировать большие объемы данных. Используется для реализации поиска данных. | 
| Fluentd |	Логирование | Инструмент для сбора, обработки и передачи логов. Поддерживает множество плагинов для интеграции с различными системами логирования и мониторинга.
| Jaeger	 | Трассировка |	Инструмент для трассировки распределенных систем. Позволяет отслеживать выполнение запросов через микросервисы и выявлять узкие места и проблемы производительности. |
| ClickHouse | Анализ данных | Высокопроизводительная система анализа данных с открытым исходным кодом. Предоставляет высокую скорость запросов, оптимальную для аналитических задач, поддерживает большие объемы данных. | 
| Victoria metrics | Мониторинг и метрики | Высокопроизводительная система мониторинга и хранения метрических данных. Обеспечивает высокую скорость записи и чтения данных, идеально подходит для отслеживания метрических показателей в больших масштабах. |
| Prometheus | Мониторинг и алертинг | Система для мониторинга и алертинга, которая собирает и хранит метрики в реальном времени. Поддерживает многомерные данные и мощные возможности для запросов и визуализации. |
| Grafana | Мониторинг и визуализация данных | Инструмент с открытым исходным кодом, позволяющий визуализировать данные из различных источников, создавать дашборды и получать ценную информацию о состоянии системы. |  
| Nginx, Envoy | Обработка запросов, Балансировка нагрузки | Высокопроизводительные веб-серверы и прокси-серверы, позволяющие эффективно обрабатывать запросы от клиентов, обеспечивать балансировку нагрузки и оптимизировать скорость и доступность сервисов. |
| GitLab | Управление версиями  и CI/CD |  Платформа для разработки программного обеспечения, включающая в себя управление версиями, CI/CD, управление проектами, мониторинг и аналитику. |
| Docker | Контейнеризация  | ПО для автоматизации развёртывания и управления приложениями в средах с поддержкой контейнеризации. Обеспечивает портативность, изоляцию и консистентность разработки, тестирования и развертывания приложений. |
| Kubernetes | Оркестратор | Открытое ПО для оркестровки контейнеризированных приложений — автоматизации их развёртывания, масштабирования и координации в условиях кластера|

### Список источников:
1. [X](https://x.com/ "сам твиттер")
2. [Statista](https://www.statista.com/statistics/242606/number-of-active-twitter-users-in-selected-countries/)
3. [Tridenstechnology](https://tridenstechnology.com/ru/c%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B0-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D0%B5%D0%B9-twitter/)
4. [MeltWater](https://www.meltwater.com/en/blog/twitter-stats-marketers-need-to-know)
5. [wifitalents](https://wifitalents.com/statistic/twitter/ "немного отличается от предыдущих статистик")
6. [quora](https://www.quora.com/Does-Twitter-store-its-data-and-if-so-where-and-how-is-it-organized#:~:text=By%20means%20of%20Hadoop%2C%20Twitter,Twitter%20is%20over%2010K%20nodes "немного инфы про RPS твиттера")
7. [oberlo](https://www.oberlo.com/statistics/number-of-twitter-users-by-country "распределение по странам")
8. [siliconangle](https://siliconangle.com/2022/12/30/twitter-reportedly-closes-sacramento-data-center-part-cost-cutting-initiative/ "где главные датацентры твиттера")
9. [servernews](https://servernews.ru/1077720 "где главные датацентры твиттера")
10. https://habr.com/ru/companies/otus/articles/674378/ - префиксное дерево
11. https://habr.com/ru/articles/533096/ - pagerank
13. https://habr.com/ru/companies/vdsina/articles/497170/ - gzip