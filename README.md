# Проектирование высоконагруженных систем
## 1. Тема и целевая аудитория
### Тема: X

Информация о сервисе и нагрузке:
- DAU 217 миллионов пользователей. (в лекции было 436, взято из [2](https://www.meltwater.com/en/blog/twitter-stats-marketers-need-to-know))

| Гендер  | Процент (%) |
| --- | ------ |
| Мужчина | 56 |
| Женщина | 44 |



| Возраст (лет) | Процент пользователей (%) |
| --- | ------ |
| 13-17 |  6.6   |
| 18-24 |  17.1   |
| 25-34 |  38.5  |
| 35-49 |  20.7   |
| 50+  | 17.1   |

MVP функционал:
- Регистрация   
- Аккаунт: профиль, информация о профиле
- Фото и видео для профиля
- твиты, фото и видео в твитах, репосты твитов
- комментарии к твитам и комментарии к комментариям(в виде дерева)
- рекомендательная система твитов
- Настройки профиля
- Поиск: поиск по хэштегам
- Уведомления

Ключевой функционал - посты и поиск по ним, переписка между пользователями.
Ключевые продуктовые решения:
- хэштеги: для поиска и группировки твитов по темам
- ретвиты

## 2. Расчет нагрузки

### Продуктовые метрики

| метрика | значение |
| --- | ------ |
| MAU |  550MM |
| DAU |  217MM |

| память на 1 | значение |
| --- | ------ |
| твит |  300 байт |
| фото | 16 кбайт |
| видео | 600 кБайт |


| действия пользователя (среднее) | значение | память |
| ---  | ---- |  --- |
| чтение твитов | 50 | - |
| лайк (твита и комментария) | 10 | 8 байт |
| поиск твита | 20 | - |
| написание комментария | 4 | 100 байт |
| написания твита | 2.4 | (расчитано ниже) |
| репост твита | 1.7 | - |

возьмём, что каждый 3 твит с видео, и в каждом твите в среднем есть 2 фотографии.

32 КБ + 200 Байт = 32.2 КБ (твит с 2 фото)
200 байт + 600 КБайт = 0.6002 МБ(твит с видео)
100 байт * 10 = 1000 байт ~ 1КБ (комментарии)

Средний размер хранилища пользователя - 532.176 КБ - пользователь/ сутки

### Технические метрики

хранения в разбивке по типам данных

| Данные | Кол-во в сутки | память в сутки (ГБ) |
| ---   |  -- |  ---              |
| твиты | 518.4 M |     145       |
| фото | 1 B |          15820     |
| видео | 172 M |       98420     |
| комментарии | 1.3 B | 81 |

| Сетевой трафик | среднее потребление | пиковое потребление |
| --- | ---- | --- |
| твиты | 0.001678  ГБ/c |  0.004195 ГБ/c  | 
| фото |  0.1831018 ГБ/c   |  0.4577545 ГБ/c  |
| видео | 1.13912037 ГБ/c   | 2.847800925  ГБ/c |

Суммарный суточный  трафик - 114466 ГБ/cутки

| RPS | средний | пик |
| ---  | ---- | --- |
| получение твита | 125787  | 314467 |
| лайк твита | 25157  | 62892 |
| поиск твита | 25574  | 62835 |
| написание комментария | 15000  | 37500 |
| написания твита | 6000 | 15000  | 
| репост твита | 4276  | 10691  |
| проверка авторизации + авторизация | 200000 | 250000 |
| изменение настроек профиля | 200 | 450 |
| подписка на / отписка от пользователя | 600 | 1500 |

## Глобальная балансировка нагрузки.

Разбиение по доменам.

x.com.static - домен для статического контента 
x.com.auth - домен для проверки регистрации/ авторизации
x.com.tweet - домен для получения твита
x.com.user - домен для получения странички пользователя - настроек



| Регион | % пользователей |
| --- | -- |
| Северная Америка | 35.62% |
| Азия | 46.20% |
| Европа | 11.90% |
| Южная Америка | 6.28% |


| Расположение ДЦ | назначение |
| --- | -- |
| Атланта (Джорджия) | основной (США) |
| Портленде (Орегон) | основной (США) |
| Даллас (Техас) |  основной (США) |
| Мумбаи (Индия) | основной (Азия) |
| Сингнапур | основной (Азия) |
| Дублин (Ирландия) | основной (Европа) |
| Нью-Йорк | CDN (США) |
| Сеул (Южная Корея) | CDN (Азия) |
| Токио (Япония) | CDN (Азия) |
| Франкфурт (Германия) | CDN (Европа) |
| Сан-Паулу (Бразилия) | CDN (Южная америка) |
| Сидней (Австралия) | CDN (Океания) | 


Такое расположение основных датацентров, потому что наибольшая часть аудитории "X" находится в США и Азии, после идёт Европа и Южная Америка. Такое расположениец ДЦ позволит ускорить доступ к сервису для большей части аудитории, а CDN ускорит отдачу статического контента в удаленных регионах и уменьшит нагрузку на основные ДЦ.

| Датацентр                              | % нагрузки    | 
| ---                                    | ----          |
| Атланта(Джорджия)                      | 14            | 
| Портленд (Орегон)                      | 14	         |
| Даллас(Техас)                          | 14	         |
| Сингнапур                              | 23.1          |
| Мумбаи (Индия)                         | 23.1          |
| Дублин (Ирландия)                      | 11.8          |


DNS балансировка - Latency-based DNS.

Latency-based DNS направляет запросы на сервер с наименьшей задержкой, постоянно измеряя время отклика.
Хорошо подходит, так как сеть глобально распределённая и сконцентрирована в некоторых странах особенно.
DNS сервера переодически проходятся по списку доступных серверов и определяют сервер с наименьшей задержкой и направляют запросы на него.

Anycast балансировка - BGP Anycast.
Будет отдельные IP для: США, Японии, Сингапура, Индии, Европы.
Будем использовать для устойчивости к сбоям, чтобы в случае если сервер выходит из строя запросы перенаправлялись на ближайший работающий. 

### Локальная балансировка нагрузки

(Опционально, мб лишний)
Для входящего трафика будем использовать L4 балансировку - Virtual Server via Direct Routing. Есть ограничение, что сервера должны быть в одной физической сети, т.е. в рамках одного ДЦ. В каждом основном ДЦ
будет стоять балансировщик который будем распределять запросы в рамках датацентра. Балансировщики будут настроены с резервированием по протоколу CARP (Common Address Redundancy Protocol), что обеспечит отказоустойчивость и автоматическое переключение на резервный балансировщик в случае отказа основного.


С L4 балансировщика трафик будет попадать на L7 балансировщик. 


Будем использовать в качестве L7 балансировщика Nginx, чтобы предотвратить блокировку серверных ресурсов от "медленных пользователей", также на уровне Nginx добавим проверку авторизации, что позволит отсеивать неавторизованные запросы ещё до их попадания в бекенд.
В случае если бек упадет во время запроса, который не меняет БД, Nginx это поймет и перенаправит запрос на другой сервер, пользователь ничего не заметит, также уменьшаем нагрузку на бек, так как держим постоянные  соединения(upstreams) с бекендом.

Межсервисные запросы: используем Envoy, Least Connections для L7 балансировки межсервисных запросов в рамках ДЦ. 

Балансировщик будет стоять в каждом 
межсервисные запросы

Отказоустойчивость: Будем использоват 2 кластера в Kubernetes с Autoscaling, что позволит в случае сбоя одного из кластеров обеспечить доступность к сервису, а autoscaling позволит увеличивать/уменьшать количество реплик в зависимости от нагрузки.



### Логическая схема БД


![Схема бд](/БД.drawio.png)

| Таблица | Размер данных на 1 запись (байт) | сумма |
| ---  | ---- | --- |
| User | 8+32+64+255+255+255+255+8+8+1  | 783  |
| Tweet  | 8+8+280+...+8+8+8+1  | 28+280+content |
| Retweet | 8+8+8+8+1  | 33 |
| Like | 8+8  | 16 |
| TweetHashtag | 8+8 | 16  | 
| Hashtag | 8+255  | 263  |
| Comment | 8+8+8+255+8+8+8+8 | 56+255+content |
| UserSetting | 8+255+255 | 518 |
| Notification | 8+8+255+1+8 | 280 |
| Session | 8+8+8+1 | 25 |



| Таблица | Размер данных | Чтение | Запись | Конситентность |
| ---  | ---- | --- | --- | --- |
| User |  1.458 ТБ (2 миллиарда пользователей) | 20000  | ~2 | п | 
| Tweet  | 1236 ТБ (если 2.5 трлн твитов всего) |   |  п |  п |
| Session | | | | |
| Retweet | 100.07 ТБ (если 2/3 постов имеют 1 репост)  |  |  п |  п |
| Like | 72.74 ТБ  | 37500 |  п |  п |
| TweetHashtag | 101.85 ТБ |  |   п |  п |
| Hashtag | 0.024 ТБ  | 10691  |  п |  п |
| Comment | 1600 ТБ | 250000 |  п |  п |
| UserSetting | 3.858 ТБ на кажд пользователя 4 настройки | 450 |  п |  п |
| Notification | 0.782 ТБ | допустим в полтора раза больше кол-ва пользователей |  п |  п |
| Session  | | |

Особенности распределения нагрузки по ключам
### Список источников:
1. [X](https://x.com/ "сам твиттер")
2. [Statista](https://www.statista.com/statistics/242606/number-of-active-twitter-users-in-selected-countries/)
3. [Tridenstechnology](https://tridenstechnology.com/ru/c%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B0-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D0%B5%D0%B9-twitter/)
4. [MeltWater](https://www.meltwater.com/en/blog/twitter-stats-marketers-need-to-know)
5. [wifitalents](https://wifitalents.com/statistic/twitter/ "немного отличается от предыдущих статистик")
6. [quora](https://www.quora.com/Does-Twitter-store-its-data-and-if-so-where-and-how-is-it-organized#:~:text=By%20means%20of%20Hadoop%2C%20Twitter,Twitter%20is%20over%2010K%20nodes "немного инфы про RPS твиттера")
7. [oberlo](https://www.oberlo.com/statistics/number-of-twitter-users-by-country "распределение по странам")
8. [siliconangle](https://siliconangle.com/2022/12/30/twitter-reportedly-closes-sacramento-data-center-part-cost-cutting-initiative/ "где главные датацентры твиттера")
9. [servernews](https://servernews.ru/1077720 "где главные датацентры твиттера")
